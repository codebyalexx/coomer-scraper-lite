# Coomer Scraper Lite - Environment Setup Guide

This guide explains all environment variables needed to run the Coomer Scraper Lite project properly.

## Quick Start

1. Copy `.env.dist` to `.env`
2. Fill in the required variables below
3. Ensure all services (PostgreSQL, Redis) are running
4. Run `npm install` and start with `npm start`

---

## Environment Variables

### Core API Configuration

#### `API_PORT`
- **Type**: Number
- **Default**: `3000`
- **Description**: Port for the Express API server
- **Example**: `3000`
- **Required**: No (uses default if omitted)

---

### Database Configuration

#### `DATABASE_URL`
- **Type**: PostgreSQL connection string
- **Format**: `postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&...]`
- **Required**: ✅ **YES**
- **Description**: PostgreSQL connection string for the main application database
- **Examples**:
  - Local: `postgresql://postgres:password@localhost:5432/coomer_db`
  - Remote: `postgresql://user:pass@db.example.com:5432/coomer_db`
  - With SSL: `postgresql://user:pass@db.example.com:5432/coomer_db?sslmode=require`
- **Notes**:
  - Prisma ORM uses this to manage all database operations
  - Database must be created before starting the application
  - Recommended: Create a dedicated database user (not postgres)

---

### Redis Cache Configuration

#### `REDIS_URL`
- **Type**: Redis connection string
- **Format**: `redis://[username[:password]@][netloc][:port][/database]`
- **Required**: ✅ **YES**
- **Description**: Redis connection for caching API responses and tracking state
- **Examples**:
  - Local: `redis://localhost:6379`
  - With auth: `redis://user:password@redis.example.com:6379/0`
  - With database selection: `redis://localhost:6379/1`
- **Notes**:
  - Used for caching Coomer.st API responses
  - Stores post selection limits and skip tracking
  - TTL-based cache (automatic expiration)
  - Database 0 is recommended unless you need isolation

---

### Discord Bot Configuration

#### `DISCORD_TOKEN`
- **Type**: Discord Bot Token (secret)
- **Required**: ✅ **YES**
- **Description**: Authentication token for Discord bot integration
- **How to get**:
  1. Go to [Discord Developer Portal](https://discord.com/developers/applications)
  2. Create a new application
  3. Navigate to "Bot" section
  4. Click "Add Bot"
  5. Copy the token from "TOKEN" section
  6. Keep this **private and secret** - never commit to git
- **Permissions needed**:
  - Send Messages
  - Read Message History
  - Add Reactions
- **Intents needed**:
  - Message Content Intent (to read URLs from messages)
  - Guild Messages
- **Notes**:
  - The bot monitors for coomer.st URLs in messages
  - Automatically adds detected artists to the scraper queue
  - Provides feedback via Discord reactions (✅/❌)

---

### Storage Server Configuration

The storage server is a dedicated Express server that handles media file uploads and streaming.

#### `STORAGE_V_API_HOST`
- **Type**: String (full URL)
- **Format**: `http://host:port/api` or `https://host:port/api`
- **Required**: ✅ **YES**
- **Description**: Base URL of the storage API server
- **Examples**:
  - Local network: `http://192.168.1.100:41500/api`
  - Localhost: `http://localhost:41500/api`
  - Remote server: `https://storage.example.com:41500/api`
- **Notes**:
  - Used by the scraper to upload downloaded files
  - Should match `STORAGE_V_HOST` and `STORAGE_V_PORT`
  - Protocol (http/https) must match your infrastructure

#### `STORAGE_V_NAME`
- **Type**: String
- **Required**: ✅ **YES**
- **Description**: Identifier/name for this storage server instance
- **Example**: `primary-storage` or `storage-1`
- **Notes**:
  - Used to distinguish between multiple storage servers
  - Stored in database for tracking which server hosts which files
  - Should be unique if running multiple storage instances

#### `STORAGE_V_HOST`
- **Type**: IP Address or Hostname
- **Required**: ✅ **YES**
- **Description**: IP address or hostname of the storage server
- **Examples**:
  - Local: `127.0.0.1` or `localhost`
  - Network: `192.168.1.100`
  - Hostname: `storage.example.com`
- **Notes**:
  - Storage server will bind to this address
  - Must be reachable from the scraper application
  - Use `0.0.0.0` to listen on all interfaces (less secure)

#### `STORAGE_V_PORT`
- **Type**: Number
- **Default**: `41500`
- **Required**: No (uses default if omitted)
- **Description**: Port for the storage server
- **Example**: `41500`
- **Notes**:
  - Must not conflict with other services
  - Common ports to avoid: 3000 (API), 5432 (PostgreSQL), 6379 (Redis)

#### `STORAGE_V_PATH`
- **Type**: Absolute file system path
- **Required**: ✅ **YES**
- **Description**: Absolute directory path where downloaded media files are stored
- **Examples**:
  - Linux/Mac: `/data/coomer-downloads` or `/mnt/media/coomer`
  - Windows: `C:\data\coomer-downloads` or `D:\media\coomer`
  - Docker: `/app/downloads`
- **Notes**:
  - Must be an absolute path (not relative)
  - Directory must exist and be writable by the application
  - Files are stored in subdirectories: `{STORAGE_V_PATH}/{artist_identifier}/`
  - Ensure sufficient disk space for media files
  - Must be the same path across scraper and storage server instances

---

## Setup Instructions by Environment

### Local Development

```env
# API
API_PORT=3000

# Database (local PostgreSQL)
DATABASE_URL=postgresql://postgres:password@localhost:5432/coomer_dev

# Redis (local)
REDIS_URL=redis://localhost:6379

# Discord Bot
DISCORD_TOKEN=your_discord_bot_token_here

# Storage (local)
STORAGE_V_API_HOST=http://localhost:41500/api
STORAGE_V_NAME=local-storage
STORAGE_V_HOST=127.0.0.1
STORAGE_V_PORT=41500
STORAGE_V_PATH=C:\data\coomer-downloads
```

### Docker Compose

```env
# API
API_PORT=3000

# Database (docker service)
DATABASE_URL=postgresql://coomer_user:secure_password@postgres:5432/coomer_db

# Redis (docker service)
REDIS_URL=redis://redis:6379

# Discord Bot
DISCORD_TOKEN=your_discord_bot_token_here

# Storage (docker service)
STORAGE_V_API_HOST=http://storage:41500/api
STORAGE_V_NAME=docker-storage
STORAGE_V_HOST=0.0.0.0
STORAGE_V_PORT=41500
STORAGE_V_PATH=/app/downloads
```

### Production Server

```env
# API
API_PORT=3000

# Database (managed database service)
DATABASE_URL=postgresql://coomer_user:secure_password@db.example.com:5432/coomer_prod

# Redis (managed Redis service)
REDIS_URL=redis://user:password@redis.example.com:6379/0

# Discord Bot
DISCORD_TOKEN=your_discord_bot_token_here

# Storage (production server)
STORAGE_V_API_HOST=https://storage.example.com:41500/api
STORAGE_V_NAME=prod-storage-01
STORAGE_V_HOST=storage.example.com
STORAGE_V_PORT=41500
STORAGE_V_PATH=/mnt/media/coomer-downloads
```

---

## Validation Checklist

Before running the application, verify:

- [ ] PostgreSQL is running and the `DATABASE_URL` is valid
- [ ] Redis is running and the `REDIS_URL` is valid
- [ ] Discord bot token is valid and bot is added to your Discord server
- [ ] `STORAGE_V_PATH` directory exists and is writable
- [ ] `STORAGE_V_HOST` and `STORAGE_V_PORT` are available (not in use)
- [ ] `STORAGE_V_API_HOST` is reachable from the scraper application
- [ ] All sensitive values (tokens, passwords) are kept out of version control
- [ ] `.env` file is listed in `.gitignore`

---

## Testing Your Setup

### Test Database Connection
```bash
npm run prisma:validate  # If available
```

### Test Redis Connection
```bash
# From your terminal, test connectivity:
redis-cli -u redis://localhost:6379 ping
# Should return: PONG
```

### Test Discord Bot
The Discord bot will automatically start when the application runs. Check Discord server for any activity.

### Test Storage Server
```bash
curl http://localhost:41500/api/handshake
# Should return: 200 OK or similar response
```

---

## Security Best Practices

1. **Never commit `.env` to git** - It's already in `.gitignore`, keep it that way
2. **Use strong database passwords** - Generate with password manager
3. **Rotate Discord token if leaked** - Regenerate in Developer Portal
4. **Use HTTPS in production** - Set `STORAGE_V_API_HOST` to `https://`
5. **Restrict Redis access** - Use authentication and network restrictions
6. **Limit storage directory permissions** - Only application user should access
7. **Use environment-specific values** - Different tokens/passwords per environment
8. **Backup `.env` securely** - Store separately from code repository

---

## Troubleshooting

### "connect ECONNREFUSED 127.0.0.1:5432"
- PostgreSQL is not running
- `DATABASE_URL` is pointing to wrong host/port
- Database doesn't exist yet

### "Error: getaddrinfo ENOTFOUND redis"
- Redis is not running
- `REDIS_URL` hostname is wrong
- Network connectivity issue

### "Invalid token" (Discord)
- Token is expired or revoked
- Token was entered incorrectly
- Bot was removed from Developer Portal

### "ENOENT: no such file or directory" (Storage)
- `STORAGE_V_PATH` directory doesn't exist
- Create it: `mkdir -p /path/to/storage`
- Ensure proper permissions

### "EADDRINUSE :::41500"
- Port 41500 is already in use
- Change `STORAGE_V_PORT` to available port
- Or kill process using the port

---

## Database Initialization

After setting up PostgreSQL and `.env`:

```bash
# Install dependencies
npm install

# Run Prisma migrations
npm run prisma:migrate

# (Optional) Seed initial data
npm run prisma:seed
```

---

## Running the Application

```bash
# Start all services
npm start

# Or run specific services:
npm run app          # Just scraper
npm run api          # Just API server
npm run storage      # Just storage server
```

Check console logs for any startup errors.

---

## Additional Resources

- [Prisma Documentation](https://www.prisma.io/docs/)
- [Redis Documentation](https://redis.io/docs/)
- [Discord.js Guide](https://discordjs.guide/)
- [Express.js Guide](https://expressjs.com/)

---

**Last Updated**: 2025-11-11
